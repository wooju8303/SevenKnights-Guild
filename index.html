<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ”¥ ê³µë¶€ ê¸¸ë“œì „ ğŸ”¥</title>
<style>
  /* --- [ìŠ¤íƒ€ì¼] Burning Soul Theme (ê³µë¶€ ê¸¸ë“œ ì „ìš©) --- */
  :root {
    --bg-color: #050000; 
    --bg-gradient: linear-gradient(to bottom, #050000 0%, #1a0505 50%, #2d0a0a 100%);
    --text-main: #FFFFFF;
    --text-sub: #ffcdcd; /* ë¶‰ì€ ë¼ê°€ ë„ëŠ” íšŒìƒ‰ */
    --accent: #FF5252; /* ê°•ë ¬í•œ ë ˆë“œ ì˜¤ë Œì§€ */
    --accent-glow: rgba(255, 82, 82, 0.5);
    --card-bg: rgba(40, 10, 10, 0.75); /* ë¶‰ì€ ìœ ë¦¬ì°½ ëŠë‚Œ */
    --card-border: rgba(255, 100, 100, 0.2);
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
    --radius: 16px;
  }

  html { background-color: var(--bg-color); height: 100%; }
  body {
    background: var(--bg-gradient);
    min-height: 100vh;
    margin: 0; padding: 20px; padding-bottom: 80px;
    color: var(--text-main);
    font-family: 'Suit', sans-serif;
    line-height: 1.6;
    position: relative;
    overflow-x: hidden;
  }

  /* ë¶ˆí‹°(Embers) ë°°ê²½ íš¨ê³¼ */
  #emberfield {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: -1;
    background-image: 
      radial-gradient(1.5px 1.5px at 15% 15%, #FF5252, transparent),
      radial-gradient(1px 1px at 50% 20%, #FF8A80, transparent),
      radial-gradient(2px 2px at 80% 10%, #FFD740, transparent), /* ê¸ˆìƒ‰ ë¶ˆí‹° */
      radial-gradient(1.5px 1.5px at 10% 60%, #FF5252, transparent),
      radial-gradient(1px 1px at 90% 80%, #FF1744, transparent),
      radial-gradient(2px 2px at 40% 90%, #FF6E40, transparent);
    background-size: 550px 550px;
    opacity: 0.8; 
  }

  h2, h3, h4 { margin-top: 0; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px; }
  
  button {
    cursor: pointer; border: none; padding: 12px 18px; border-radius: 10px;
    font-weight: bold; transition: 0.2s; font-size: 0.9rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.5);
  }
  button:active { transform: scale(0.98); }

  .glass-card {
    background: var(--card-bg); 
    border: 1px solid var(--card-border);
    box-shadow: var(--card-shadow); 
    border-radius: var(--radius);
    backdrop-filter: blur(4px);
  }

  input, select, textarea {
    background: #1a0505; border: 1px solid #5a1a1a; color: #FFF;
    padding: 14px; border-radius: 10px; width: 100%;
    box-sizing: border-box; margin-bottom: 8px;
    font-size: 0.95rem; outline: none;
    transition: border 0.3s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); background: #2b0808; box-shadow: 0 0 8px var(--accent-glow); }
  
  /* ëŒ€ì‹œë³´ë“œ */
  #dashboardScreen { display: none; flex-direction: column; gap: 20px; max-width: 500px; margin: 0 auto; margin-top: 30px; }
  
  .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .logout-btn { background: rgba(255, 23, 68, 0.2); color: #FF1744; border: 1px solid rgba(255, 23, 68, 0.4); padding: 8px 12px; font-size: 0.8rem; }

  .dash-btn-big {
    background: linear-gradient(135deg, #c62828, #8e0000); /* ê°•ë ¬í•œ ë ˆë“œ ê·¸ë¼ë°ì´ì…˜ */
    color: #FFF; font-size: 1.5rem; height: 150px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    border: 1px solid rgba(255, 100, 100, 0.3);
    box-shadow: 0 10px 30px rgba(198, 40, 40, 0.4);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  .dash-btn-small {
    background: linear-gradient(135deg, #424242, #212121);
    color: #EEE; font-size: 1.1rem; height: 80px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .back-btn { background: rgba(255,255,255,0.1); color: #AAA; padding: 8px 12px; font-size: 0.8rem; }

  .grid-list {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .item-btn {
    background: rgba(40, 10, 10, 0.8); border: 1px solid var(--card-border);
    color: var(--text-sub); padding: 15px 5px; border-radius: 12px;
    min-height: 85px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: 0.2s;
  }
  .item-btn.active {
    background: rgba(255, 82, 82, 0.2); border: 1px solid var(--accent);
    color: #FFF; font-weight: bold; box-shadow: 0 0 15px var(--accent-glow);
  }
  
  /* PVE íŒŒê´´ì‹  ê°•ì¡° íš¨ê³¼ */
  .item-btn.burn-active {
    background: linear-gradient(135deg, #b71c1c, #4a0000);
    border: 1px solid #ff5252;
    box-shadow: 0 0 15px rgba(255, 82, 82, 0.6);
    color: #fff;
    font-weight: bold;
    animation: burnPulse 2s infinite alternate;
  }
  @keyframes burnPulse {
    0% { box-shadow: 0 0 10px rgba(255, 82, 82, 0.4); transform: scale(1); }
    100% { box-shadow: 0 0 25px rgba(255, 82, 82, 0.9); transform: scale(1.02); }
  }

  .detail-card {
    background: #1a0505; border: 1px solid #5a1a1a;
    box-shadow: var(--card-shadow); border-radius: var(--radius);
    padding: 25px; display: none; margin-bottom: 30px;
  }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
  .info-item { 
    background: #2b0808; padding: 12px; border-radius: 8px; font-size: 0.9rem; 
    border: 1px solid #4a1515; color: #EEE;
  }
  .info-item.full { grid-column: span 2; }
  .info-label { display: block; color: var(--accent); font-size: 0.75rem; margin-bottom: 5px; font-weight: bold; }

  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%; 
    z-index: 2000;
    background: #1a0505; border: 1px solid var(--accent); border-radius: var(--radius);
    margin-top: 8px; max-height: 400px; overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.9);
  }
  .dropdown-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; color: #FFF; }
  .dropdown-item:hover { background: rgba(255, 82, 82, 0.1); }

  .admin-panel {
    background: #120202; border: 1px solid #5a1a1a; padding: 20px; border-radius: 12px; 
    margin-top: 30px; display: none; position: relative; z-index: 500;
    box-shadow: 0 10px 50px #000;
  }
  .mini-btn { padding: 4px 8px; font-size: 0.75rem; margin-left: 2px; }
  .bg-blue { background: #d32f2f; color: #FFF; } 
  .bg-red { background: #5a1a1a; color: #CCC; border:1px solid #777; }

  /* ìœ ì € ìŠ¹íŒ¨ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ */
  .user-stat-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px; border-bottom: 1px solid #331010; font-size: 0.9rem;
  }

  /* PVE ìŠ¤íƒ€ì¼ */
  .pve-tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
  .pve-tab { flex: 1; padding: 12px; background: #331010; color: #aaa; text-align: center; border-radius: 10px; font-weight: bold; border: 1px solid transparent; cursor: pointer; transition: 0.3s; }
  .pve-tab.active { background: #7f0000; color: #fff; border-color: #FF5252; box-shadow: 0 0 10px rgba(255,82,82,0.3); }

  .pve-content-box { white-space: pre-wrap; word-break: break-all; color: #DDD; font-size: 0.95rem; line-height: 1.6; min-height: 20px; }
  
  /* PVE ì„ íƒ ì…€ë ‰íŠ¸ë°•ìŠ¤ ê³µí†µ */
  .pve-select-box {
    background: #1a0505; color: #FFF; border: 1px solid #FF5252; padding: 10px; font-weight: bold;
    text-align: center; margin: 0 auto; display: block; width: auto; min-width: 150px;
    box-shadow: 0 0 10px rgba(255,82,82,0.3); cursor: pointer;
  }

  /* ëª¨ë‹¬ ê³µí†µ */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 3000;
    align-items: center; justify-content: center;
  }
  .modal-content {
    background: #1a0505; border: 1px solid var(--accent); 
    border-radius: var(--radius); padding: 25px; width: 90%; max-width: 400px;
    box-shadow: 0 0 30px var(--accent-glow); max-height: 90vh; overflow-y: auto;
  }

  footer {
    text-align: center; margin-top: 50px; padding: 20px;
    color: rgba(255,200,200,0.3); font-size: 0.8rem; border-top: 1px solid #331010;
  }
</style>
</head>
<body>

<div id="emberfield"></div>

<div id="loginScreen" style="text-align:center; margin-top:100px;">
  <div style="font-size:3.5rem; margin-bottom:10px; filter: drop-shadow(0 0 15px #FF5252);">ğŸ”¥</div>
  <h2 style="font-size:2.2rem; margin-bottom:30px; color:var(--text-main); text-shadow: 0 0 10px rgba(255,82,82,0.6);">ê³µë¶€ ê¸¸ë“œì „</h2>
  
  <div class="glass-card" style="padding:30px; display:inline-block; width: 80%; max-width: 300px; border: 1px solid rgba(255,82,82,0.3);">
    <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px; font-weight:bold;">ì „ì¥ ì…ì¥</p>
    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„" style="text-align:center;">
    <input type="password" id="codeInput" placeholder="CODE (6ìë¦¬)" style="text-align:center; letter-spacing: 5px;">
    <button onclick="tryLogin()" style="width:100%; background:var(--accent); color:#FFF; margin-top:15px; font-size:1rem; padding:15px; box-shadow: 0 0 15px var(--accent-glow);">ì…ì¥í•˜ê¸°</button>
  </div>
  <div style="margin-top:40px;">
    <button onclick="adminLogin()" style="background:transparent; color:#775555; font-size:0.8rem;">[ ê´€ë¦¬ì ì „ìš© ]</button>
  </div>
</div>

<div id="dashboardScreen">
  <div class="dash-header">
    <h3 id="dashNick" style="color:var(--accent); margin:0;">í™˜ì˜í•©ë‹ˆë‹¤</h3>
    <button onclick="doLogout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  
  <button class="dash-btn-big" onclick="goAttackMode()">
    <div style="font-size:2.5rem; margin-bottom:10px;">âš”ï¸</div>
    ê¸¸ë“œì „ ê³µê²©í•˜ê¸°
  </button>
  
  <button class="dash-btn-small" onclick="goDefenseMode()">
    ğŸ›¡ï¸ ì¶”ì²œ ë°©ì–´íŒ€ ë³´ê¸°
  </button>

  <button class="dash-btn-small" onclick="goPveMode()" style="background: linear-gradient(135deg, #4A148C, #311B92); border-color:#7C4DFF;">
    ğŸ° PVE ê³µëµì‹¤ (ê³µì„±/ê°•ë¦¼)
  </button>
</div>

<div id="attackScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  <div class="nav-header">
    <button class="back-btn" onclick="goDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
    <button onclick="toggleAttackAdmin()" id="atkAdminBtn" style="background:#331010; color:#AAA; font-size:0.8rem; padding:6px 12px;">+ ê´€ë¦¬ì</button>
  </div>

  <div style="margin-bottom:20px;">
    <div id="currentNick" style="color:var(--text-main); font-weight:bold; font-size:1.1rem; margin-bottom:4px;"></div>
    <div id="myStats" style="color:var(--text-sub); font-size:0.85rem;">ë‚´ ì „ì  ë¡œë”©ì¤‘...</div>
  </div>

  <div style="position:relative; margin-bottom:25px; z-index:1000;">
    <div class="glass-card" onclick="toggleDefDropdown()" style="padding:15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
      <span id="defCurrentText" style="font-weight:bold;">ğŸ›¡ï¸ ë°©ì–´íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
      <span style="color:var(--accent);">â–¼</span>
    </div>
    <div id="defListDropdown" class="dropdown-list">
      <div style="padding:10px; background:#1a0505; position:sticky; top:0;">
        <input type="text" id="defSearchInput" placeholder="ğŸ” ê²€ìƒ‰..." oninput="filterDefense()" onclick="event.stopPropagation()">
      </div>
      <div id="defRealList"></div>
      <div id="defAddBtnArea"></div>
    </div>
  </div>

  <div id="attackList" class="grid-list"></div>
  
  <div id="atkSuggestBtn" style="text-align:center; margin-bottom:20px; display:none;">
    <button onclick="openModal('attack')" style="background:#1a0505; border:1px dashed #5a1a1a; color:#AAA; width:100%; padding:15px;">+ ê³µê²©ë± ì œë³´í•˜ê¸°</button>
  </div>

  <div id="attackCard" class="detail-card">
    <h2 style="border-bottom:1px solid #5a1a1a; padding-bottom:15px; margin-bottom:10px;">
      <span id="cardFire"></span> <span id="cardName"></span>
      <span style="float:right; font-size:0.6em; color:#AAA; font-weight:normal;">ìŠ¹ë¥  <span id="cardRate" style="color:var(--accent); font-size:1.4em;">0</span>%</span>
      <div id="cardMaker" style="font-size:0.4em; color:#885555; font-weight:normal; margin-top:5px;"></div>
    </h2>
    <div class="info-grid">
      <div class="info-item"><span class="info-label">ì „ì </span><span id="cardWin">0</span>ìŠ¹ <span id="cardLose">0</span>íŒ¨</div>
      <div class="info-item"><span class="info-label">ì†ê³µ</span><span id="cardType">-</span></div>
      <div class="info-item"><span class="info-label">ë°˜ì§€</span><span id="cardRing">-</span></div>
      <div class="info-item"><span class="info-label">í«</span><span id="cardPet">-</span></div>
      <div class="info-item full"><span class="info-label">ì§„í˜•</span><span id="cardFormation">-</span></div>
      <div class="info-item full"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="cardSkill">-</span></div>
      <div class="info-item full"><span class="info-label">ì¥ë¹„ì„¸íŒ… ë° íŠ¹ì´ì‚¬í•­</span><span id="cardArmor">-</span></div>
      <div class="info-item full"><span class="info-label">ìµœê·¼ 5ê²½ê¸°</span><div id="recentRecord" style="letter-spacing:3px;">-</div></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button onclick="addWin()" style="background:#1b5e20; color:#fff; width:48%; padding:15px;">ğŸ† ìŠ¹ë¦¬</button>
      <button onclick="addLose()" style="background:#b71c1c; color:#fff; width:48%; padding:15px;">ğŸ’€ íŒ¨ë°°</button>
    </div>
    <div style="text-align:right; margin-top:10px;">
       <button onclick="resetRecord()" style="background:transparent; color:#775555; font-size:0.8rem; text-decoration:underline;">[ê´€ë¦¬ì] ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div style="margin-top:40px; border-top:1px solid #331010; padding-top:20px;">
    <h3 style="font-size:1rem; color:#AAA;">ğŸ”¥ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
    <div id="rankingList" class="glass-card" style="padding:0; overflow:hidden; background:rgba(0,0,0,0.4);"></div>
    <div id="moreRankMsg" style="text-align:center; color:#775555; font-size:0.8rem; margin-top:10px; display:none;">* 11ìœ„ ì´í•˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <div id="attackAdminPanel" class="admin-panel">
    <h4 style="color:#FFF;">ğŸ› ï¸ ê³µê²© ê´€ë¦¬ì</h4>
    <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
      <div style="color:#EF5350; margin-bottom:5px;">ğŸ”” ê³µê²©ë± ì œë³´ ê´€ë¦¬</div>
      <div id="atkSuggestionList" style="color:#888; font-size:0.9rem;">(ì œë³´ ì—†ìŒ)</div>
    </div>
    <div style="margin-bottom:20px;">
      <div style="color:#FFAB91; margin-bottom:5px;">ğŸ›¡ï¸ ë°©ì–´íŒ€ ê´€ë¦¬</div>
      <input type="text" id="newDefName" placeholder="ìƒˆ ë°©ì–´íŒ€ ì´ë¦„">
      <button onclick="addDefense()" class="bg-blue">ì¶”ê°€</button>
      <button onclick="delDefense()" class="bg-red">í˜„ì¬ ë°©ì–´íŒ€ ì‚­ì œ</button>
    </div>
    <div style="margin-bottom:20px;">
      <div style="color:#FFAB91; margin-bottom:5px;">âš”ï¸ ê³µê²©íŒ€ ì§ì ‘ ê´€ë¦¬</div>
      <input type="text" id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
      <select id="atkType">
        <option value="" disabled selected>ì†ê³µ ì„ íƒ</option>
        <option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option>
        <option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option>
      </select>
      <input type="text" id="ringRec" placeholder="ë°˜ì§€">
      <input type="text" id="atkPet" placeholder="í«">
      <input type="text" id="atkFormation" placeholder="ì§„í˜•">
      <textarea id="armorRec" rows="2" placeholder="ì¥ë¹„/íŠ¹ì´ì‚¬í•­"></textarea>
      <input type="text" id="skillOrder" placeholder="ìŠ¤í‚¬">
      <div style="margin-top:5px;">
        <button onclick="addAttack()" class="bg-blue">ì¶”ê°€</button>
        <button onclick="editAttack()" class="bg-blue">ìˆ˜ì •</button>
        <button onclick="delAttack()" class="bg-red">ì‚­ì œ</button>
      </div>
    </div>
    <div>
      <div style="color:#FFAB91; margin-bottom:5px;">ğŸ”‘ ê¸¸ë“œì› ì…ì¥ì½”ë“œ ê´€ë¦¬</div>
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="text" id="newUserNick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="issueKey()" style="background:#2E7D32; color:#fff; width:60px;">ë°œê¸‰</button>
      </div>
      <input type="text" id="keySearchInput" placeholder="ğŸ” ë°œê¸‰ëœ í‚¤ ê²€ìƒ‰..." oninput="filterKeys()" style="margin-bottom:5px; background:#1a0505; border:1px solid #5a1a1a; padding:8px; width:100%; box-sizing:border-box;">
      
      <div id="userKeyList" style="max-height:150px; overflow-y:auto; margin-bottom:15px;"></div>
      
      <div style="color:#FFAB91; margin-bottom:5px; border-top:1px solid #331010; padding-top:15px;">ğŸ‘¥ ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì •</div>
      <div id="adminUserList" style="max-height:200px; overflow-y:auto;"></div>
    </div>
  </div>
</div>

<div id="defenseScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  <div class="nav-header">
    <button class="back-btn" onclick="goDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
    <button onclick="toggleDefenseAdmin()" id="defAdminBtn" style="background:#331010; color:#AAA; font-size:0.8rem; padding:6px 12px;">+ ê´€ë¦¬ì</button>
  </div>

  <h3 style="text-align:center; color:var(--accent); margin-bottom:20px;">ğŸ”¥ ì¶”ì²œ ë°©ì–´íŒ€ ëª©ë¡ ğŸ”¥</h3>
  
  <div id="recDefList" class="grid-list"></div>

  <div style="text-align:center; margin-top:30px;">
    <button onclick="openModal('defense')" style="background:#1a0505; border:1px dashed #5a1a1a; color:#AAA; width:100%; padding:15px;">+ ë‚´ ë°©ì–´ë± ì œë³´í•˜ê¸°</button>
  </div>

  <div id="recDefCard" class="detail-card">
    <h2 style="border-bottom:1px solid #5a1a1a; padding-bottom:10px; margin-bottom:10px;">
      <span id="rdName"></span>
      <div id="rdMaker" style="font-size:0.4em; color:#885555; font-weight:normal;"></div>
    </h2>
    <div class="info-grid">
      <div class="info-item full"><span class="info-label">ë°˜ì§€ ì¶”ì²œ</span><span id="rdHeroes">-</span></div>
      <div class="info-item"><span class="info-label">ì§„í˜•</span><span id="rdFormation">-</span></div>
      <div class="info-item"><span class="info-label">í«</span><span id="rdPet">-</span></div>
      <div class="info-item full"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="rdSkill">-</span></div>
      <div class="info-item full"><span class="info-label">ì„¤ëª… ë° íŒ</span><span id="rdDesc">-</span></div>
    </div>
  </div>

  <div id="defenseAdminPanel" class="admin-panel">
    <h4 style="color:#FFF;">ğŸ› ï¸ ë°©ì–´íŒ€ ê´€ë¦¬ì</h4>
    <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
      <div style="color:#EF5350; margin-bottom:5px;">ğŸ”” ë°©ì–´ë± ì œë³´ ê´€ë¦¬</div>
      <div id="defSuggestionList" style="color:#888; font-size:0.9rem;">(ì œë³´ ì—†ìŒ)</div>
    </div>
    <div>
      <div style="color:#FFAB91; margin-bottom:5px;">ğŸ“ ì¶”ì²œ ë°©ì–´íŒ€ ì§ì ‘ ì¶”ê°€</div>
      <input type="text" id="rdInputName" placeholder="ì˜ˆ: ì˜¤ê³µ í”„ë ˆì´ì•¼ ì—ì´ìŠ¤">
      <input type="text" id="rdInputHeroes" placeholder="ë°˜ì§€ ì¶”ì²œ">
      <input type="text" id="rdInputFormation" placeholder="ì§„í˜•">
      <input type="text" id="rdInputPet" placeholder="í«">
      <input type="text" id="rdInputSkill" placeholder="ìŠ¤í‚¬ìˆœì„œ">
      <textarea id="rdInputDesc" rows="2" placeholder="ì„¤ëª…"></textarea>
      <div style="margin-top:5px;">
        <button onclick="addRecDefense()" class="bg-blue">ì¶”ê°€</button>
        <button onclick="editRecDefense()" class="bg-blue">ìˆ˜ì • ì €ì¥</button>
        <button onclick="delRecDefense()" class="bg-red">ì‚­ì œ</button>
      </div>
    </div>
  </div>
</div>

<div id="pveScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  <div class="nav-header">
    <button class="back-btn" onclick="goDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
  </div>
  
  <h3 style="text-align:center; color:#AAA; margin-bottom:10px;">ğŸ° PVE ê³µëµì‹¤</h3>
  
  <div class="pve-tab-container">
    <div id="tabSiege" class="pve-tab active" onclick="renderPveList('siege')">ê³µì„±ì „</div>
    <div id="tabAdvent" class="pve-tab" onclick="renderPveList('advent')">ê°•ë¦¼ì›ì •ëŒ€</div>
  </div>

  <div id="pveList" class="grid-list"></div>

  <div id="pveDetailCard" class="detail-card" style="position:relative;">
    <h2 id="pveCardTitle" style="border-bottom:1px solid #5a1a1a; padding-bottom:15px; margin-bottom:20px; color:#FF5252;"></h2>
    
    <div id="pveTurnArea" style="display:none; text-align:center; margin-bottom:20px;">
       <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">â³ í„´ ìˆ˜ ì„ íƒ</div>
       <select id="pveTurnSelect" class="pve-select-box" onchange="changePveTurn()">
         <option value="8">8í„´</option>
         <option value="12">12í„´</option>
         <option value="16">16í„´</option>
         <option value="20">20í„´</option>
         <option value="24">24í„´</option>
       </select>
    </div>

    <div id="pveRoundArea" style="display:none; text-align:center; margin-bottom:20px;">
       <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">ğŸ”„ ë¼ìš´ë“œ ì„ íƒ</div>
       <select id="pveRoundSelect" class="pve-select-box" onchange="changePveRound()">
         <option value="r1">1ë¼ìš´ë“œ</option>
         <option value="r2">2ë¼ìš´ë“œ</option>
       </select>
    </div>

    <div id="pveBuildArea" style="display:none; text-align:center; margin-bottom:20px;">
       <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">ğŸ› ï¸ ë¹Œë“œ ì„ íƒ</div>
       <select id="pveBuildSelect" class="pve-select-box" onchange="changePveBuild()">
         <option value="build1">ë¹Œë“œ 1</option>
         <option value="build2">ë¹Œë“œ 2</option>
       </select>
    </div>

    <div id="pveViewMode">
      <div class="info-item full" style="margin-bottom:15px;">
        <span class="info-label">âš”ï¸ ë± ì¡°í•©</span>
        <div id="viewPveDeck" class="pve-content-box">-</div>
      </div>
      <div class="info-item full" style="margin-bottom:15px;">
        <span class="info-label">ğŸ“œ ìŠ¤í‚¬ ìˆœì„œ</span>
        <div id="viewPveSkill" class="pve-content-box">-</div>
      </div>
      <div class="info-item full">
        <span class="info-label">ğŸ›¡ï¸ ì¥ë¹„ ì„¸íŒ… ë° íŒ</span>
        <div id="viewPveEquip" class="pve-content-box">-</div>
      </div>
      <div style="text-align:right; margin-top:20px;">
        <button id="pveEditBtn" onclick="enablePveEdit()" style="background:#4A148C; color:#FFF; font-size:0.8rem;">[ê´€ë¦¬ì ìˆ˜ì •]</button>
      </div>
    </div>

    <div id="pveEditMode" style="display:none;">
      
      <div style="display:flex; justify-content:flex-end; gap:5px; margin-bottom:15px; border-bottom:1px solid #331010; padding-bottom:10px;">
        <button onclick="copyPveData()" style="background:#555; color:#fff; font-size:0.7rem; padding:5px 8px;">ğŸ“¤ í˜„ì¬ ê³µëµ ë³µì‚¬</button>
        <button onclick="pastePveData()" style="background:#555; color:#fff; font-size:0.7rem; padding:5px 8px;">ğŸ“¥ ê³µëµ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>

      <div style="margin-bottom:5px; color:#FF5252; font-size:0.8rem;">ë± ì¡°í•© (1ì¤„)</div>
      <input id="editPveDeck" placeholder="ì˜ˆ: ì˜¤ê³µ/ì„¸ì¸/ì•„ì¼ë¦°/ë ˆì´ì²¼/ì œì´ë¸Œ">
      
      <div style="margin-bottom:5px; color:#FF5252; font-size:0.8rem;">ìŠ¤í‚¬ ìˆœì„œ (2~4ì¤„)</div>
      <textarea id="editPveSkill" rows="4" placeholder="1ë¼: ...&#13;&#10;2ë¼: ..."></textarea>
      
      <div style="margin-bottom:5px; color:#FF5252; font-size:0.8rem;">ì¥ë¹„ ì„¸íŒ… (5~6ì¤„)</div>
      <textarea id="editPveEquip" rows="6" placeholder="ì¥ë¹„ ë° ì ì¬ ì„¸íŒ…..."></textarea>
      
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="savePveData()" style="flex:1; background:#2E7D32; color:#FFF;">ì €ì¥</button>
        <button onclick="cancelPveEdit()" style="flex:1; background:#331010; color:#FFF;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
</div>

<div id="modalOverlay" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modalTitle" style="color:var(--text-main); margin-bottom:15px;">ì œë³´í•˜ê¸°</h3>
    <div id="modalBody"></div>
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button id="modalSubmitBtn" style="flex:1; background:var(--accent); color:#FFF;">ì œë³´</button>
      <button onclick="closeModal()" style="flex:1; background:#331010; color:#fff;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="adminReviewModal" class="modal-overlay">
  <div class="modal-content" style="border-color:#EF5350;">
    <h3 style="color:#FFF; margin-bottom:15px;">ğŸ§ ì œë³´ ìƒì„¸ ê²€í† </h3>
    <div id="adminReviewBody" style="font-size:0.9rem; color:#DDD; margin-bottom:20px;"></div>
    <div style="display:flex; gap:10px;">
      <button id="btnReviewApprove" style="flex:1; background:#2E7D32; color:#FFF;">ìŠ¹ì¸</button>
      <button id="btnReviewReject" style="flex:1; background:#C62828; color:#FFF;">ê±°ì ˆ</button>
      <button onclick="closeAdminReviewModal()" style="flex:1; background:#331010; color:#FFF;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<footer>
  <div style="margin-bottom:5px;">Designed & Developed by <b>ê³µë¶€ ê¸¸ë“œ</b></div>
  <div style="font-size:0.7rem;">Copyright Â© 2026 Hwarang Guild. All rights reserved.</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// [ë³€ê²½ëœ DB Config] Sena Hwarang
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513"; // [ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ]

let myNick = "";
let currentDefense = ""; 
let currentAttack = ""; 
let currentRecDef = ""; 
let adminOpen = false;
let isAdminAuthenticated = false; 

let allLogsCache = []; 
let defenseDataCache = {}; 

window.onload = () => {
  const storedNick = localStorage.getItem("nickname");
  const storedKey = localStorage.getItem("accessKey");
  if (storedNick && storedKey) {
    if(storedNick === "ê´€ë¦¬ì" && storedKey === "ADMIN") isAdminAuthenticated = true;
    checkLogin(storedNick, storedKey, true);
  } else {
    showLogin();
  }
};

/* --- í™”ë©´ ì „í™˜ --- */
function showLogin() {
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("attackScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "none";
  document.getElementById("pveScreen").style.display = "none";
}

function showDashboard() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("dashboardScreen").style.display = "flex";
  document.getElementById("attackScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "none";
  document.getElementById("pveScreen").style.display = "none";
  document.getElementById("dashNick").textContent = `${myNick}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤`;
}

window.goDashboard = showDashboard;

window.goAttackMode = () => {
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("attackScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `ë‹‰ë„¤ì„ : ${myNick}`;
  document.getElementById("myStats").textContent = "ë‚´ ì „ì  ë¡œë”©ì¤‘...";
  renderRanking(); 
};

window.goDefenseMode = () => {
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "block";
  loadRecDefenseList(); 
};

window.goPveMode = () => {
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("pveScreen").style.display = "block";
  renderPveList('siege'); // ê¸°ë³¸: ê³µì„±ì „
};

window.doLogout = () => {
  if(!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  localStorage.removeItem("nickname");
  localStorage.removeItem("accessKey");
  location.reload();
};

/* --- ë¡œê·¸ì¸ --- */
window.tryLogin = () => {
  const nick = document.getElementById("nickInput").value.trim();
  const key = document.getElementById("codeInput").value.trim();
  if(!nick || !key) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”.");
  checkLogin(nick, key, false);
};

async function checkLogin(nick, key, isAuto) {
  const userRef = ref(db, `allowedUsers/${nick}`);
  const snap = await get(userRef);
  if (snap.exists() && String(snap.val().code) === key) {
    localStorage.setItem("nickname", nick);
    localStorage.setItem("accessKey", key); 
    myNick = nick;
    showDashboard();
  } else {
    if(!isAuto) alert("ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    else showLogin();
  }
}

window.adminLogin = () => {
  if(prompt("ë¹„ë°€ë²ˆí˜¸") === ADMIN_PW) {
    localStorage.setItem("nickname", "ê´€ë¦¬ì");
    localStorage.setItem("accessKey", "ADMIN");
    myNick = "ê´€ë¦¬ì";
    isAdminAuthenticated = true; 
    showDashboard();
  } else { alert("ì˜¤ë¥˜"); }
};

function checkPW() { 
  if(isAdminAuthenticated) return true; 
  if(prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸") === ADMIN_PW) {
    isAdminAuthenticated = true; 
    return true;
  }
  return false;
}

/* --- [ê³µê²© ëª¨ë“œ] --- */
window.toggleAttackAdmin = () => {
  const panel = document.getElementById("attackAdminPanel");
  const btn = document.getElementById("atkAdminBtn");
  if(panel.style.display === "none") {
    if(!checkPW()) return; 
    panel.style.display = "block";
    btn.textContent = "- ë‹«ê¸°";
    renderUserKeys();
    renderAtkSuggestions();
    renderAdminUserList();
  } else {
    panel.style.display = "none";
    btn.textContent = "+ ê´€ë¦¬ì";
  }
  renderRanking(); 
};

window.toggleDefDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
  if(list.style.display==="block") {
    document.getElementById("defSearchInput").value="";
    filterDefense();
  }
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.glass-card') && !e.target.closest('.dropdown-list')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

onValue(ref(db,"defenseTeams"), snap => {
  const realList = document.getElementById("defRealList");
  realList.innerHTML = "";
  defenseDataCache = snap.val() || {};
  if(defenseDataCache) {
    Object.entries(defenseDataCache).forEach(([k, v]) => {
      const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
      const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
      const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
      const div = document.createElement("div");
      div.className = "dropdown-item";
      div.innerHTML = `<b>${v.name}</b> <small style="color:#AAA;">${rate}% (${tWins}ìŠ¹ ${tLose}íŒ¨)</small>`;
      div.onclick = () => {
        document.getElementById("defCurrentText").textContent = v.name;
        document.getElementById("defListDropdown").style.display = "none";
        loadAttackTeams(k);
      };
      realList.appendChild(div);
    });
  }
});

window.filterDefense = () => {
  const filter = document.getElementById("defSearchInput").value.toLowerCase();
  const items = document.getElementById("defRealList").children;
  for(let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(filter) ? "" : "none";
  }
};

window.loadAttackTeams = (dk) => {
  currentDefense = dk; currentAttack = "";
  document.getElementById("attackCard").style.display = "none";
  document.getElementById("atkSuggestBtn").style.display = "block";
  
  document.getElementById("atkName").value = "";
  document.getElementById("atkType").value = "";
  document.getElementById("ringRec").value = "";
  document.getElementById("atkPet").value = "";
  document.getElementById("atkFormation").value = ""; 
  document.getElementById("armorRec").value = "";
  document.getElementById("skillOrder").value = "";

  const list = document.getElementById("attackList");
  list.innerHTML = "";
  
  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    list.innerHTML = "";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      const b = document.createElement("div");
      b.className = "item-btn";
      const fire = r >= 70 ? "<span style='color:#FF5252'>ğŸ”¥</span>" : "";
      b.innerHTML = `<div>${fire} ${av.name}</div><div style="font-size:0.8rem; color:#AAA;">${r}% (${av.win}ìŠ¹ ${av.lose}íŒ¨)</div>`;
      b.onclick = () => {
        document.querySelectorAll("#attackList .item-btn").forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      list.appendChild(b);
    });
  });
  renderAtkSuggestions();
};

window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    document.getElementById("cardMaker").textContent = d.maker ? `By. ${d.maker}` : "";
    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    const total = d.win + d.lose;
    const r = total ? Math.round(d.win/total*100) : 0;
    document.getElementById("cardRate").textContent = r;
    document.getElementById("cardFire").textContent = r>=70 ? "ğŸ”¥" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardPet").textContent = d.pet || "-";
    document.getElementById("cardFormation").textContent = d.formation || "-";
    
    document.getElementById("cardArmor").textContent = d.armor || "-";
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);

    document.getElementById("atkName").value = d.name;
    document.getElementById("atkType").value = d.type;
    document.getElementById("ringRec").value = d.ring;
    document.getElementById("atkPet").value = d.pet||"";
    document.getElementById("atkFormation").value = d.formation||"";
    document.getElementById("armorRec").value = d.armor;
    document.getElementById("skillOrder").value = d.skill;
  });
};

async function loadRecentRecord(dk, ak){
  const snap = await get(ref(db,"logs"));
  const div = document.getElementById("recentRecord");
  if(!snap.exists()) { div.innerHTML="-"; return; }
  const logs = Object.values(snap.val()).filter(v => v.defense===dk && v.attack===ak).sort((a,b)=>b.time-a.time).slice(0,5);
  let html="";
  logs.forEach(v => { html += (v.result==="win" ? "<span style='color:#66BB6A'>W</span> " : "<span style='color:#EF5350'>L</span> "); });
  div.innerHTML = html || "-";
}

async function writeLog(res){
  if(!currentDefense || !currentAttack) return;
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  const atk = snap.val();
  push(ref(db,"logs"), {
    nick:myNick, result:res, defense:currentDefense, attack:currentAttack,
    attackName:atk.name, attackType:atk.type, date:new Date().toISOString().slice(0,10), time:Date.now()
  });
}
window.addWin = async () => {
  if(!confirm("ìŠ¹ë¦¬ ê¸°ë¡?")) return;
  const w = +document.getElementById("cardWin").textContent;
  await update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win:w+1 });
  writeLog("win");
};
window.addLose = async () => {
  if(!confirm("íŒ¨ë°° ê¸°ë¡?")) return;
  const l = +document.getElementById("cardLose").textContent;
  await update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose:l+1 });
  writeLog("lose");
};
window.resetRecord = () => {
  if(checkPW()) update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};

window.addDefense = ()=>{ if(checkPW()) push(ref(db,"defenseTeams"),{name:document.getElementById("newDefName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };
window.addAttack = ()=>{
  if(!checkPW()) return;
  push(ref(db,`defenseTeams/${currentDefense}/attackTeams`), {
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value,
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value,
    formation:document.getElementById("atkFormation").value, 
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), {
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value,
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value,
    formation:document.getElementById("atkFormation").value,
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value
  });
  alert("ìˆ˜ì •ë¨");
};
window.delAttack = ()=>{ if(checkPW()) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

// ì œë³´ (ê³µê²©)
function renderAtkSuggestions() {
  const div = document.getElementById("atkSuggestionList");
  onValue(ref(db, "suggestions/attack"), snap => {
    div.innerHTML = "";
    const all = snap.val();
    if(!all) { div.innerHTML="(ì—†ìŒ)"; return; }
    Object.entries(all).forEach(([dk, sub]) => {
      const dName = defenseDataCache[dk]?.name || "ì‚­ì œëœë°©ì–´íŒ€";
      Object.entries(sub).forEach(([sk, v]) => {
        const d = document.createElement("div");
        d.style.marginBottom="10px"; d.style.borderBottom="1px solid #331010";
        d.innerHTML = `
          <div style="color:#FFF">[${dName}] ${v.name}</div>
          <div style="font-size:0.8rem; color:#888;">ì œë³´ì: ${v.suggester}</div>
          <button class="mini-btn bg-blue" onclick="openAdminReview('attack', '${dk}', '${sk}')">ê²€í† </button>
        `;
        div.appendChild(d);
      });
    });
  });
}

// [NEW] ê´€ë¦¬ì ê²€í†  ëª¨ë‹¬ ê´€ë ¨
window.openAdminReview = async (type, k1, k2) => {
  document.getElementById("adminReviewModal").style.display = "flex";
  const body = document.getElementById("adminReviewBody");
  body.innerHTML = "ë¡œë”©ì¤‘...";
  
  let path = type === 'attack' ? `suggestions/attack/${k1}/${k2}` : `suggestions/defense/${k1}`;
  const snap = await get(ref(db, path));
  const data = snap.val();
  
  if(!data) {
    body.innerHTML = "ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }

  let html = `<p><b style="color:var(--accent)">ì´ë¦„:</b> ${data.name}</p>`;
  if(type === 'attack') {
    html += `
      <p><b>ì†ê³µ:</b> ${data.type}</p>
      <p><b>ë°˜ì§€:</b> ${data.ring}</p>
      <p><b>í«:</b> ${data.pet}</p>
      <p><b>ì§„í˜•:</b> ${data.formation || '-'}</p>
      <p><b>ì¥ë¹„/íŒ:</b> ${data.armor}</p>
      <p><b>ìŠ¤í‚¬:</b> ${data.skill}</p>
    `;
    document.getElementById("btnReviewApprove").onclick = () => { approveAtk(k1, k2); closeAdminReviewModal(); };
    document.getElementById("btnReviewReject").onclick = () => { rejectAtk(k1, k2); closeAdminReviewModal(); };
  } else {
    html += `
      <p><b>ë°˜ì§€ ì¶”ì²œ:</b> ${data.heroes}</p>
      <p><b>ì§„í˜•:</b> ${data.formation}</p>
      <p><b>í«:</b> ${data.pet}</p>
      <p><b>ìŠ¤í‚¬:</b> ${data.skill || '-'}</p>
      <p><b>ì„¤ëª…:</b> ${data.desc}</p>
    `;
    document.getElementById("btnReviewApprove").onclick = () => { approveDef(k1); closeAdminReviewModal(); };
    document.getElementById("btnReviewReject").onclick = () => { rejectDef(k1); closeAdminReviewModal(); };
  }
  body.innerHTML = html;
};
window.closeAdminReviewModal = () => { document.getElementById("adminReviewModal").style.display = "none"; };

window.approveAtk = async (dk, sk) => {
  const snap = await get(ref(db, `suggestions/attack/${dk}/${sk}`));
  const d = snap.val();
  if(!d) return;
  await push(ref(db, `defenseTeams/${dk}/attackTeams`), {
    name:d.name, type:d.type, ring:d.ring, pet:d.pet, 
    formation:d.formation, armor:d.armor, skill:d.skill, win:0, lose:0, maker:d.suggester
  });
  await remove(ref(db, `suggestions/attack/${dk}/${sk}`));
  alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
};
window.rejectAtk = (dk,sk) => { 
  if(confirm("ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(db, `suggestions/attack/${dk}/${sk}`)); 
};


/* --- [ë°©ì–´ ëª¨ë“œ] ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ --- */
window.toggleDefenseAdmin = () => {
  const panel = document.getElementById("defenseAdminPanel");
  const btn = document.getElementById("defAdminBtn");
  if(panel.style.display === "none") {
    if(!checkPW()) return;
    panel.style.display = "block";
    btn.textContent = "- ë‹«ê¸°";
    renderDefSuggestions();
  } else {
    panel.style.display = "none";
    btn.textContent = "+ ê´€ë¦¬ì";
  }
};

window.loadRecDefenseList = () => {
  const list = document.getElementById("recDefList");
  onValue(ref(db, "recommendedDefenses"), snap => {
    list.innerHTML = "";
    document.getElementById("recDefCard").style.display = "none";
    const data = snap.val();
    if(!data) { list.innerHTML = "<div style='color:#555;'>ë“±ë¡ëœ ì¶”ì²œ ë°©ì–´íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
    
    Object.entries(data).forEach(([key, val]) => {
      const div = document.createElement("div");
      div.className = "item-btn";
      div.innerHTML = `<div style="font-weight:bold; color:#FFF;">${val.name}</div>`;
      div.onclick = () => {
        document.querySelectorAll("#recDefList .item-btn").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        showRecDefDetail(key, val);
      };
      list.appendChild(div);
    });
  });
};

function showRecDefDetail(key, val) {
  currentRecDef = key;
  document.getElementById("recDefCard").style.display = "block";
  document.getElementById("rdName").textContent = val.name;
  document.getElementById("rdMaker").textContent = val.maker ? `By. ${val.maker}` : "";
  document.getElementById("rdHeroes").textContent = val.heroes || "-";
  document.getElementById("rdFormation").textContent = val.formation || "-";
  document.getElementById("rdPet").textContent = val.pet || "-";
  document.getElementById("rdSkill").textContent = val.skill || "-";
  document.getElementById("rdDesc").innerHTML = (val.desc || "-").replace(/\n/g,"<br>");

  document.getElementById("rdInputName").value = val.name;
  document.getElementById("rdInputHeroes").value = val.heroes;
  document.getElementById("rdInputFormation").value = val.formation;
  document.getElementById("rdInputPet").value = val.pet;
  document.getElementById("rdInputSkill").value = val.skill || "";
  document.getElementById("rdInputDesc").value = val.desc;
}

window.addRecDefense = () => {
  if(!checkPW()) return;
  push(ref(db, "recommendedDefenses"), {
    name: document.getElementById("rdInputName").value,
    heroes: document.getElementById("rdInputHeroes").value,
    formation: document.getElementById("rdInputFormation").value,
    pet: document.getElementById("rdInputPet").value,
    skill: document.getElementById("rdInputSkill").value,
    desc: document.getElementById("rdInputDesc").value,
    maker: "ê´€ë¦¬ì"
  });
};
window.editRecDefense = () => {
  if(!checkPW() || !currentRecDef) return;
  update(ref(db, `recommendedDefenses/${currentRecDef}`), {
    name: document.getElementById("rdInputName").value,
    heroes: document.getElementById("rdInputHeroes").value,
    formation: document.getElementById("rdInputFormation").value,
    pet: document.getElementById("rdInputPet").value,
    skill: document.getElementById("rdInputSkill").value,
    desc: document.getElementById("rdInputDesc").value
  });
  alert("ìˆ˜ì •ë¨");
};
window.delRecDefense = () => {
  if(!checkPW() || !currentRecDef) return;
  if(confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) remove(ref(db, `recommendedDefenses/${currentRecDef}`));
};

function renderDefSuggestions() {
  const div = document.getElementById("defSuggestionList");
  onValue(ref(db, "suggestions/defense"), snap => {
    div.innerHTML = "";
    const all = snap.val();
    if(!all) { div.innerHTML="(ì—†ìŒ)"; return; }
    Object.entries(all).forEach(([k, v]) => {
      const d = document.createElement("div");
      d.style.marginBottom="10px"; d.style.borderBottom="1px solid #331010";
      d.innerHTML = `
        <div style="color:#FFF">${v.name}</div>
        <div style="font-size:0.8rem; color:#888;">ì œë³´ì: ${v.suggester}</div>
        <button class="mini-btn bg-blue" onclick="openAdminReview('defense', '${k}', '')">ê²€í† </button>
      `;
      div.appendChild(d);
    });
  });
}
window.approveDef = async (key) => {
  const snap = await get(ref(db, `suggestions/defense/${key}`));
  const d = snap.val();
  if(!d) return;
  await push(ref(db, "recommendedDefenses"), {
    name:d.name, heroes:d.heroes, formation:d.formation, pet:d.pet, 
    skill:d.skill||"", desc:d.desc, maker:d.suggester
  });
  await remove(ref(db, `suggestions/defense/${key}`));
  alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
};
window.rejectDef = (key) => { 
  if(confirm("ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(db, `suggestions/defense/${key}`)); 
};


/* --- [PVE] ê³µì„±ì „/ê°•ë¦¼ì›ì •ëŒ€ ë¡œì§ --- */
let pveCurrentCategory = "siege"; // siege or advent
let pveCurrentId = "";
let currentPveSubOption = null; // í„´ìˆ˜ ë˜ëŠ” ë¼ìš´ë“œ ë˜ëŠ” ë¹Œë“œ

// [ë³€ê²½] ê³µì„±ì „ì— type: "build" ì†ì„± ì¶”ê°€
const PVE_DATA_KEYS = {
  siege: [
    {id:"mon", name:"ì›”ìš”ì¼ ê³µì„±ì „", type:"build"}, 
    {id:"tue", name:"í™”ìš”ì¼ ê³µì„±ì „", type:"build"}, 
    {id:"wed", name:"ìˆ˜ìš”ì¼ ê³µì„±ì „", type:"build"}, 
    {id:"thu", name:"ëª©ìš”ì¼ ê³µì„±ì „", type:"build"},
    {id:"fri", name:"ê¸ˆìš”ì¼ ê³µì„±ì „", type:"build"}, 
    {id:"sat", name:"í† ìš”ì¼ ê³µì„±ì „", type:"build"}, 
    {id:"sun", name:"ì¼ìš”ì¼ ê³µì„±ì „", type:"build"}
  ],
  advent: [
    {id:"destruct1", name:"ğŸ”¥ íŒŒê´´ì‹  1ë¼", type:"turn", burn:true}, 
    {id:"destruct2", name:"ğŸ”¥ íŒŒê´´ì‹  2ë¼", type:"turn", burn:true},
    {id:"teo", name:"íƒœì˜¤", type:"round"}, 
    {id:"kyle", name:"ì¹´ì¼", type:"round"},
    {id:"yeonhee", name:"ì—°í¬", type:"round"}, 
    {id:"karma", name:"ì¹´ë¥´ë§ˆ", type:"round"}
  ]
};

window.renderPveList = (cat) => {
  pveCurrentCategory = cat;
  document.getElementById("pveDetailCard").style.display = "none";
  document.getElementById("tabSiege").className = cat==='siege' ? "pve-tab active" : "pve-tab";
  document.getElementById("tabAdvent").className = cat==='advent' ? "pve-tab active" : "pve-tab";

  const list = document.getElementById("pveList");
  list.innerHTML = "";

  PVE_DATA_KEYS[cat].forEach(item => {
    const div = document.createElement("div");
    div.className = item.burn ? "item-btn burn-active" : "item-btn";
    div.innerHTML = `<div style="font-weight:bold; color:#FFF;">${item.name}</div>`;
    div.onclick = () => {
      // ì„ íƒ ì‹œ active íš¨ê³¼ (ì„ íƒë¨)
      document.querySelectorAll("#pveList .item-btn").forEach(b => {
          if(!b.classList.contains("burn-active")) b.classList.remove("active");
      });
      if(!item.burn) div.classList.add("active");
      loadPveData(cat, item.id, item.name, item.type);
    };
    list.appendChild(div);
  });
};

// PVE ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì˜µì…˜ ê³ ë ¤)
window.loadPveData = (cat, id, title, type) => {
  pveCurrentId = id;
  const card = document.getElementById("pveDetailCard");
  card.style.display = "block";
  document.getElementById("pveCardTitle").textContent = title;

  const turnArea = document.getElementById("pveTurnArea");
  const roundArea = document.getElementById("pveRoundArea");
  const buildArea = document.getElementById("pveBuildArea");

  // ì˜µì…˜ ì˜ì—­ ì´ˆê¸°í™”
  turnArea.style.display = 'none';
  roundArea.style.display = 'none';
  buildArea.style.display = 'none';
  currentPveSubOption = null;

  if (type === 'turn') {
    turnArea.style.display = 'block';
    currentPveSubOption = document.getElementById("pveTurnSelect").value;
  } else if (type === 'round') {
    roundArea.style.display = 'block';
    currentPveSubOption = document.getElementById("pveRoundSelect").value;
  } else if (type === 'build') {
    // [ì¶”ê°€] ë¹Œë“œ íƒ€ì… ì²˜ë¦¬
    buildArea.style.display = 'block';
    document.getElementById("pveBuildSelect").value = "build1"; // ê¸°ë³¸ê°’
    currentPveSubOption = "build1";
  }
  
  fetchPveRealData();
};

// í„´ ë³€ê²½ ì‹œ í˜¸ì¶œ
window.changePveTurn = () => {
  currentPveSubOption = document.getElementById("pveTurnSelect").value;
  fetchPveRealData();
};

// ë¼ìš´ë“œ ë³€ê²½ ì‹œ í˜¸ì¶œ
window.changePveRound = () => {
  currentPveSubOption = document.getElementById("pveRoundSelect").value;
  fetchPveRealData();
};

// [ì¶”ê°€] ë¹Œë“œ ë³€ê²½ ì‹œ í˜¸ì¶œ
window.changePveBuild = () => {
  currentPveSubOption = document.getElementById("pveBuildSelect").value;
  fetchPveRealData();
};

function fetchPveRealData() {
  // ë·° ëª¨ë“œ ì´ˆê¸°í™”
  document.getElementById("pveViewMode").style.display = "block";
  document.getElementById("pveEditMode").style.display = "none";
  document.getElementById("viewPveDeck").textContent = "ë¡œë”©ì¤‘...";
  document.getElementById("viewPveSkill").textContent = "";
  document.getElementById("viewPveEquip").textContent = "";

  // DB ê²½ë¡œ ê²°ì • (ì˜µì…˜ì´ ìˆìœ¼ë©´ í•˜ìœ„ ê²½ë¡œ ì¶”ê°€)
  let dbPath = `pve/${pveCurrentCategory}/${pveCurrentId}`;
  if(currentPveSubOption) dbPath += `/${currentPveSubOption}`;

  onValue(ref(db, dbPath), snap => {
    const d = snap.val();
    if(d) {
      document.getElementById("viewPveDeck").textContent = d.deck || "-";
      document.getElementById("viewPveSkill").textContent = d.skill || "-";
      document.getElementById("viewPveEquip").textContent = d.equip || "-";
    } else {
      document.getElementById("viewPveDeck").textContent = "(ë“±ë¡ëœ ê³µëµì´ ì—†ìŠµë‹ˆë‹¤)";
      document.getElementById("viewPveSkill").textContent = "";
      document.getElementById("viewPveEquip").textContent = "";
    }
  }, { onlyOnce: true });
}

// PVE ìˆ˜ì • ëª¨ë“œ ì§„ì…
window.enablePveEdit = () => {
  if(!checkPW()) return;
  document.getElementById("pveViewMode").style.display = "none";
  document.getElementById("pveEditMode").style.display = "block";
  
  // í˜„ì¬ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°
  let deck = document.getElementById("viewPveDeck").textContent;
  if(deck === "(ë“±ë¡ëœ ê³µëµì´ ì—†ìŠµë‹ˆë‹¤)") deck = "";
  document.getElementById("editPveDeck").value = deck;
  document.getElementById("editPveSkill").value = document.getElementById("viewPveSkill").textContent;
  document.getElementById("editPveEquip").value = document.getElementById("viewPveEquip").textContent;
};

window.cancelPveEdit = () => {
  document.getElementById("pveViewMode").style.display = "block";
  document.getElementById("pveEditMode").style.display = "none";
};

window.savePveData = async () => {
  if(!pveCurrentCategory || !pveCurrentId) return;
  
  const deck = document.getElementById("editPveDeck").value;
  const skill = document.getElementById("editPveSkill").value;
  const equip = document.getElementById("editPveEquip").value;

  // DB ê²½ë¡œ ê²°ì •
  let dbPath = `pve/${pveCurrentCategory}/${pveCurrentId}`;
  if(currentPveSubOption) dbPath += `/${currentPveSubOption}`;

  await update(ref(db, dbPath), {
    deck: deck,
    skill: skill,
    equip: equip,
    updatedAt: Date.now()
  });
  
  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  
  // í™”ë©´ ê°±ì‹ 
  document.getElementById("viewPveDeck").textContent = deck;
  document.getElementById("viewPveSkill").textContent = skill;
  document.getElementById("viewPveEquip").textContent = equip;
  cancelPveEdit();
};

/* --- [ì¶”ê°€] ê³µëµ ê³µìœ  ê¸°ëŠ¥ (ë³µì‚¬/ë¶™ì—¬ë„£ê¸°) --- */
window.copyPveData = () => {
  const data = {
    deck: document.getElementById("editPveDeck").value,
    skill: document.getElementById("editPveSkill").value,
    equip: document.getElementById("editPveEquip").value
  };
  const code = btoa(encodeURIComponent(JSON.stringify(data)));
  navigator.clipboard.writeText(code).then(() => {
    alert("í˜„ì¬ ê³µëµì´ ì½”ë“œë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ë¥¸ ì‚¬ì´íŠ¸ë‚˜ ê²Œì‹œíŒì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
  }).catch(err => {
    alert("ë³µì‚¬ ì‹¤íŒ¨: " + err);
  });
};

window.pastePveData = () => {
  const code = prompt("ê³µìœ ë°›ì€ ê³µëµ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:");
  if(!code) return;
  try {
    const jsonStr = decodeURIComponent(atob(code));
    const data = JSON.parse(jsonStr);
    
    document.getElementById("editPveDeck").value = data.deck || "";
    document.getElementById("editPveSkill").value = data.skill || "";
    document.getElementById("editPveEquip").value = data.equip || "";
    
    alert("ê³µëµì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!\n[ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.");
  } catch(e) {
    alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
};


/* --- ëª¨ë‹¬ ê³µí†µ --- */
let modalType = ""; 
window.openModal = (type) => {
  modalType = type;
  document.getElementById("modalOverlay").style.display = "flex";
  const body = document.getElementById("modalBody");
  
  if(type === 'attack') {
    if(!currentDefense) { alert("ë°©ì–´íŒ€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); closeModal(); return; }
    document.getElementById("modalTitle").textContent = "ê³µê²©ë± ì œë³´";
    body.innerHTML = `
      <input id="mName" placeholder="ê³µê²©íŒ€ ì´ë¦„ (í•„ìˆ˜)">
      <select id="mType"><option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option><option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option></select>
      <input id="mRing" placeholder="ë°˜ì§€">
      <input id="mPet" placeholder="í«">
      <input id="mFormation" placeholder="ì§„í˜•">
      <textarea id="mArmor" rows="2" placeholder="ì¥ë¹„/íŠ¹ì´ì‚¬í•­"></textarea>
      <input id="mSkill" placeholder="ìŠ¤í‚¬ìˆœì„œ">
    `;
    document.getElementById("modalSubmitBtn").onclick = submitAttackSug;
  } else {
    document.getElementById("modalTitle").textContent = "ë°©ì–´ë± ì œë³´";
    // [ì¶”ê°€] ìŠ¤í‚¬ ìˆœì„œ ì…ë ¥ì°½
    body.innerHTML = `
      <input id="mDefName" placeholder="ë°©ì–´íŒ€ ì´ë¦„ (í•„ìˆ˜)">
      <input id="mHeroes" placeholder="ë°˜ì§€ ì¶”ì²œ">
      <input id="mForm" placeholder="ì§„í˜•">
      <input id="mPet" placeholder="í«">
      <input id="mSkillDef" placeholder="ìŠ¤í‚¬ìˆœì„œ">
      <textarea id="mDesc" rows="3" placeholder="ì„¤ëª… ë° íŒ"></textarea>
    `;
    document.getElementById("modalSubmitBtn").onclick = submitDefenseSug;
  }
};
window.closeModal = () => { document.getElementById("modalOverlay").style.display = "none"; };

function submitAttackSug() {
  const name = document.getElementById("mName").value;
  if(!name) return alert("ì´ë¦„ í•„ìˆ˜");
  push(ref(db, `suggestions/attack/${currentDefense}`), {
    name:name, type:document.getElementById("mType").value,
    ring:document.getElementById("mRing").value, pet:document.getElementById("mPet").value,
    formation:document.getElementById("mFormation").value, 
    armor:document.getElementById("mArmor").value, skill:document.getElementById("mSkill").value,
    suggester:myNick, timestamp:Date.now()
  });
  alert("ì œë³´ ì™„ë£Œ"); closeModal();
}

function submitDefenseSug() {
  const name = document.getElementById("mDefName").value;
  if(!name) return alert("ì´ë¦„ í•„ìˆ˜");
  push(ref(db, `suggestions/defense`), {
    name:name, heroes:document.getElementById("mHeroes").value,
    formation:document.getElementById("mForm").value, pet:document.getElementById("mPet").value,
    skill: document.getElementById("mSkillDef").value,
    desc:document.getElementById("mDesc").value,
    suggester:myNick, timestamp:Date.now()
  });
  alert("ì œë³´ ì™„ë£Œ"); closeModal();
}

function renderRanking() {
  const list = document.getElementById("rankingList");
  const myStatDiv = document.getElementById("myStats");
  if(myStatDiv) myStatDiv.textContent = `ë‚´ ì „ì : ${myNick} / 0ìŠ¹ 0íŒ¨ (0%)`;

  onValue(ref(db,"logs"), snap => {
    allLogsCache = snap.val() || {};
    list.innerHTML = "";
    
    if(!Object.keys(allLogsCache).length) { 
        list.innerHTML="<div style='text-align:center; padding:10px; color:#555'>ê¸°ë¡ ì—†ìŒ</div>"; 
        return; 
    }
    
    const stats = {};
    Object.values(allLogsCache).forEach(v => {
      if(!stats[v.nick]) stats[v.nick]={w:0,l:0,rw:0,rl:0,logs:[]};
      stats[v.nick].logs.push(v);
    });
    
    const rankData = Object.entries(stats).map(([n, d]) => {
      d.logs.sort((a,b)=>b.time-a.time);
      d.w = d.logs.filter(l=>l.result==="win").length;
      d.l = d.logs.filter(l=>l.result==="lose").length;
      const recent = d.logs.slice(0,30);
      d.rw = recent.filter(l=>l.result==="win").length;
      d.rl = recent.filter(l=>l.result==="lose").length;
      return { nick:n, ...d };
    }).sort((a,b) => b.w - a.w);

    const myD = rankData.find(x=>x.nick===myNick);
    if(myD) {
      const tot = myD.w+myD.l; 
      if(myStatDiv) myStatDiv.textContent = `ë‚´ ì „ì : ${rankData.indexOf(myD)+1}ìœ„ / ${myD.w}ìŠ¹ ${myD.l}íŒ¨ (${tot?Math.round(myD.w/tot*100):0}%)`;
    }

    let hide = 0;
    rankData.forEach((d, i) => {
      if(!document.getElementById("attackAdminPanel").style.display.includes("block") && i>=10) { hide++; return; } 
      
      const tot = d.w+d.l;
      const r = tot ? Math.round(d.w/tot*100) : 0;
      const rTot = d.rw+d.rl;
      const rr = rTot ? Math.round(d.rw/rTot*100) : 0;
      
      const div = document.createElement("div");
      div.className = "user-stat-row";
      div.style.borderBottom="1px solid rgba(255,255,255,0.1)";
      let badge = `<span style="width:20px; text-align:center; display:inline-block; color:#666;">${i+1}</span>`;
      if(i===0) badge="ğŸ¥‡"; if(i===1) badge="ğŸ¥ˆ"; if(i===2) badge="ğŸ¥‰";
      
      div.innerHTML = `
        <div>${badge} <span style="font-weight:bold; color:#fff;">${d.nick}</span></div>
        <div style="text-align:right;">
          <div style="font-size:0.9rem; color:#ccc;">${d.w}ìŠ¹ ${d.l}íŒ¨ (${r}%)</div>
          <div style="font-size:0.75rem; color:#888;">ìµœê·¼: ${d.rw}ìŠ¹ ${d.rl}íŒ¨ (${rr}%)</div>
        </div>
      `;
      list.appendChild(div);
    });
    document.getElementById("moreRankMsg").style.display = hide>0 ? "block":"none";
  });
}

window.issueKey = async () => {
  const n = document.getElementById("newUserNick").value.trim();
  if(!n) return;
  const c = Math.floor(100000+Math.random()*900000);
  await set(ref(db, `allowedUsers/${n}`), { code:c.toString(), createdAt:Date.now() });
  document.getElementById("newUserNick").value="";
};

// [ì¶”ê°€] í‚¤ ê²€ìƒ‰ ê¸°ëŠ¥
window.filterKeys = () => {
  const filter = document.getElementById("keySearchInput").value.toLowerCase();
  const list = document.getElementById("userKeyList");
  const rows = list.getElementsByClassName("user-stat-row");
  
  for (let row of rows) {
    const nick = row.querySelector("b").textContent.toLowerCase();
    // ë‹‰ë„¤ì„ì´ ê²€ìƒ‰ì–´ë¥¼ í¬í•¨í•˜ë©´ flex, ì•„ë‹ˆë©´ ìˆ¨ê¹€
    row.style.display = nick.includes(filter) ? "flex" : "none";
  }
};

function renderUserKeys() {
  const div = document.getElementById("userKeyList");
  onValue(ref(db,"allowedUsers"), snap => {
    div.innerHTML="";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([n,v]) => {
      const r = document.createElement("div");
      r.className = "user-stat-row";
      r.innerHTML = `
        <div><b style="color:#fff">${n}</b> <span style="color:#AAA; margin-left:5px;">${v.code}</span></div>
        <button onclick="deleteUser('${n}')" style="background:#700; color:#fff; font-size:0.7rem; padding:3px 6px;">ì‚­ì œ</button>
      `;
      div.appendChild(r);
    });
    // ë¦¬ìŠ¤íŠ¸ ê°±ì‹  í›„ì—ë„ ê²€ìƒ‰ í•„í„° ìœ ì§€
    const currentFilter = document.getElementById("keySearchInput").value;
    if(currentFilter) filterKeys();
  });
}
window.deleteUser = async (n) => {
  if(!confirm("ì‚­ì œ?")) return;
  await remove(ref(db, `allowedUsers/${n}`));
};

window.adjustScore = async (nick, type, delta) => {
  if(delta === 1) {
    push(ref(db,"logs"),{
      nick: nick, result: type, defense: "admin", attack: "manual_adjust",
      attackName: "ê´€ë¦¬ììˆ˜ì •", attackType: "", date: new Date().toISOString().slice(0,10), time: Date.now()
    });
  } else {
    const snap = await get(ref(db, "logs"));
    if(!snap.exists()) return alert("ê¸°ë¡ ì—†ìŒ");
    const logs = Object.entries(snap.val()).map(([k,v]) => ({...v, key:k}))
      .filter(v => v.nick === nick && v.result === type).sort((a,b) => b.time - a.time);
    if(logs.length === 0) return alert("ê¸°ë¡ ì—†ìŒ");
    await remove(ref(db, `logs/${logs[0].key}`));
  }
};

function renderAdminUserList() {
  const listDiv = document.getElementById("adminUserList"); listDiv.innerHTML = "";
  const stat = {};
  
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0};
    if(v.result === "win") stat[v.nick].w++; else stat[v.nick].l++;
  });
  
  get(ref(db, "allowedUsers")).then(snap => {
    const users = snap.val() || {};
    Object.keys(users).forEach(u => {
        if(!stat[u]) stat[u] = {w:0, l:0};
    });

    Object.keys(stat).sort().forEach(nick => {
      const val = stat[nick];
      const div = document.createElement("div");
      div.className = "user-stat-row";
      div.innerHTML = `
        <span style="font-weight:bold; width:80px; color:var(--text-main);">${nick}</span>
        <div style="display:flex; align-items:center; gap:5px;">
          <span style="color:#66BB6A; font-size:0.8rem;">ìŠ¹:${val.w}</span>
          <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','win',1)">+</button>
          <button class="mini-btn bg-red" onclick="adjustScore('${nick}','win',-1)">-</button>
          <span style="color:#EF5350; font-size:0.8rem; margin-left:5px;">íŒ¨:${val.l}</span>
          <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','lose',1)">+</button>
          <button class="mini-btn bg-red" onclick="adjustScore('${nick}','lose',-1)">-</button>
        </div>
      `;
      listDiv.appendChild(div);
    });
  });
}
</script>
</body>
</html>
